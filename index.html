<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sachin Dashboard ‚Äî v2.1 (Nasdaq DL + Expanded Econ)</title>
<meta name="description" content="LIVE dashboard using Nasdaq Data Link (ZACKS/EA) for earnings and TE (with local fallback) for economic events. 14-day window." />
<link rel="manifest" href="manifest.webmanifest" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Sachin Dashboard" />
<link rel="apple-touch-icon" href="icons/icon-180.png" />
<style>
  :root{
    --bg:#121212; --panel:#1d1a16; --muted:#2a2620; --text:#f2f2f2;
    --accent:#ff8c00; --accent-2:#6a4a1f; --sales-bg:#153a28; --sales-br:#1f6a4a;
  }
  *{box-sizing:border-box} body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  header{padding:10px 14px;background:var(--panel);display:flex;gap:12px;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;border-bottom:1px solid #2a2620}
  header .title{display:flex;align-items:center;gap:10px}
  header .badge{font-size:.75rem;opacity:.8;border:1px solid #333;border-radius:999px;padding:2px 8px}
  button{background:var(--accent);color:#1a1209;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  button:active{transform:translateY(1px)} .wrap{padding:16px;max-width:1100px;margin:0 auto}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);padding:14px;border-radius:12px;border:1px solid #2a2620}
  h3{margin:.2rem 0 1rem;font-weight:800}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .pill{padding:8px 12px;border-radius:999px;background:var(--muted);border:1px solid #3b3227;display:flex;gap:8px;align-items:center;white-space:nowrap}
  .pill.sales{background:var(--sales-bg);border-color:var(--sales-br)}
  .ev{background:var(--muted);padding:10px;border-radius:10px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;border:1px solid #3b3227}
  .row{display:flex;gap:8px;align-items:center}
  small{opacity:.8} .section-note{opacity:.75;font-size:.9rem;margin:.5rem 0 0}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .settings{display:none;position:fixed;right:16px;bottom:16px;background:var(--panel);border:1px solid #3b3227;border-radius:12px;padding:12px;max-width:360px;z-index:20}
  .settings input{width:100%;padding:8px;border-radius:8px;border:1px solid #3b3227;background:#15110c;color:var(--text);margin-top:6px}
  .settings label{font-size:.9rem;opacity:.9}
  .banner{margin:12px 0;padding:10px;border-radius:10px;background:#21160f;border:1px dashed #5d4b33}
  .error{color:#ffcccc} .warn{color:#ffd7a8}
  .hl-today{ background:#1f3b2a; border-color:#2f7a4a; }
  .hl-tomorrow{ background:#3a2a15; border-color:#a86e1a; }
</style>
</head>
<body>
<header>
  <div class="title">
    <div style="font-weight:900;">Sachin Dashboard</div>
    <span class="badge">v2.1 ¬∑ Nasdaq Data Link + expanded econ ¬∑ 14-day</span>
  </div>
  <div class="controls">
    <button id="toggleNextWeek">Show next week</button>
    <button id="refreshBtn">Refresh</button>
    <button id="settingsBtn" title="Settings (keys)">‚öôÔ∏è Settings</button>
  </div>
</header>

<div class="wrap">
  <div id="liveBanner" class="banner" style="display:none"></div>

  <div class="grid">
    <div class="card">
      <h3>Earnings (next 14 days)</h3>
      <div id="upcomingList" class="chips"></div>
      <div class="section-note">
        Source: <code>Nasdaq Data Link ‚Üí ZACKS/EA</code>. Key can be set in ‚öôÔ∏è or <code>/data/nasdaq_key.txt</code>. No FMP.
      </div>
    </div>

    <div class="card">
      <h3>Specials (next 14 days)</h3>
      <div id="specialList" class="chips"></div>
      <div class="section-note">Monthly OPEX &amp; VIX Settlement (AM SOQ) auto-computed if inside the window.</div>
    </div>
  </div>

  <div class="card" id="thisWeek">
    <h3 id="thisWeekTitle">Economic events ‚Äî This week</h3>
    <div id="thisWeekList"></div>
  </div>

  <div class="card" id="nextWeek" style="display:none;">
    <h3 id="nextWeekTitle">Economic events ‚Äî Next week</h3>
    <div id="nextWeekList"></div>
  </div>
</div>

<!-- Settings -->
<div class="settings" id="settingsPanel">
  <h4 style="margin:0 0 8px">üîß Settings</h4>
  <div>
    <label>Nasdaq Data Link API Key (for live earnings)</label>
    <input id="nasdaqKey" placeholder="YOUR_NASDAQ_DATALINK_API_KEY">
  </div>
  <div style="margin-top:8px">
    <label>TradingEconomics Key (optional, econ)</label>
    <input id="teKey" placeholder="guest:guest or your_key:your_secret">
  </div>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="saveKeys">Save</button>
    <button id="closeSettings">Close</button>
  </div>
  <div class="section-note">Keys are stored locally in your browser (localStorage). You may also prefill Nasdaq key via <code>/data/nasdaq_key.txt</code> in the repo (visible publicly).</div>
</div>

<script>
/* ===== Utils ===== */
function tzNow(){ return new Date(); }
const DAY = 86400000;
function addDays(d, n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+n); }
function fmtDateISO(d){ const m = String(d.getMonth()+1).padStart(2,'0'); const day = String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; }
function fmtHuman(d){ return d.toLocaleString(undefined, {weekday:'short', month:'short', day:'numeric'}); }
function fmtTime(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function endOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999); }
function between(dt, from, to){ return dt >= from && dt <= to; }
function classifyHighlight(dt){
  if(!(dt instanceof Date)) return '';
  const now = tzNow();
  const todayStart = startOfDay(now);
  const todayEnd   = endOfDay(now);
  const tomorrowStart = addDays(todayStart, 1);
  const tomorrowEnd   = endOfDay(tomorrowStart);
  if (between(dt, todayStart, todayEnd)) return 'hl-today';
  if (between(dt, tomorrowStart, tomorrowEnd)) return 'hl-tomorrow';
  return '';
}

/* ===== Controls ===== */
document.getElementById('refreshBtn').addEventListener('click', () => location.reload(true));
const toggleBtn = document.getElementById('toggleNextWeek');
const nextWeekCard = document.getElementById('nextWeek');
toggleBtn.addEventListener('click', () => {
  const show = nextWeekCard.style.display === 'none';
  nextWeekCard.style.display = show ? 'block' : 'none';
  toggleBtn.textContent = show ? 'Hide next week' : 'Show next week';
});

/* ===== Ranges ===== */
const now = tzNow();
const from = startOfDay(now);
const to   = endOfDay(addDays(now, 14));
const dayIdx = (now.getDay()+6)%7; // Mon=0
const thisMon = addDays(now, -dayIdx);
const thisSun = addDays(thisMon, 6);
const nextMon = addDays(thisMon, 7);
const nextSun = addDays(thisSun, 7);
function titleRange(start, end){ const opts = { month:'short', day:'numeric', year:'numeric'}; return `${start.toLocaleDateString(undefined,opts)} ‚Üí ${end.toLocaleDateString(undefined,opts)}`; }
document.getElementById('thisWeekTitle').textContent = `Economic events ‚Äî This week (${titleRange(thisMon, thisSun)})`;
document.getElementById('nextWeekTitle').textContent = `Economic events ‚Äî Next week (${titleRange(nextMon, nextSun)})`;

/* ===== Settings storage ===== */
const settingsBtn = document.getElementById('settingsBtn');
const settingsPanel = document.getElementById('settingsPanel');
const teKeyInput  = document.getElementById('teKey');
const nasdaqKeyInput = document.getElementById('nasdaqKey');
document.getElementById('closeSettings').onclick = () => settingsPanel.style.display = 'none';
settingsBtn.onclick = async () => {
  const teKey = localStorage.getItem('sachin:teKey') || '';
  teKeyInput.value = teKey;
  const k = await loadNasdaqKey();
  nasdaqKeyInput.value = localStorage.getItem('sachin:nasdaqKey') || k || '';
  settingsPanel.style.display = 'block';
};
document.getElementById('saveKeys').onclick = () => {
  localStorage.setItem('sachin:teKey', teKeyInput.value.trim());
  localStorage.setItem('sachin:nasdaqKey', nasdaqKeyInput.value.trim());
  settingsPanel.style.display = 'none';
  location.reload();
};

// Prefill mechanism
const DEFAULT_NASDAQ_KEY = ""; // optionally hard-code here (visible publicly)
async function loadNasdaqKey(){
  // priority: localStorage > nasdaq_key.txt > DEFAULT_NASDAQ_KEY
  const saved = (localStorage.getItem('sachin:nasdaqKey') || '').trim();
  if (saved) return saved;
  try{
    const r = await fetch('./data/nasdaq_key.txt', { cache: 'no-store' });
    if (r.ok){
      const t = (await r.text()).trim();
      if (t) return t;
    }
  }catch(e){ /* ignore */ }
  return DEFAULT_NASDAQ_KEY;
}

/* ===== Watchlist (incl. CRWV, CSCO) ===== */
const WATCHLIST = ["HOOD","NVDA","PLTR","AMD","AAPL","GOOG","TSLA","TSM","AVGO","MSFT","ARM","AMZN","SPXL","TQQQ","SMCI","COIN","AI","WMT","META","NFLX","COST","LOW","TGT","CRWV","CSCO"];

/* ===== UI helpers ===== */
const upcomingEl = document.getElementById('upcomingList');
const specialEl  = document.getElementById('specialList');
const liveBanner = document.getElementById('liveBanner');

function addPill({ticker, date, kind, sales=false}){
  const pill = document.createElement('div');
  pill.className = 'pill' + (sales ? ' sales' : '');
  const d = date ? new Date(date+'T00:00:00') : null;
  if (d){ const hl = classifyHighlight(d); if (hl) pill.classList.add(hl); }
  pill.textContent = `${sales ? 'üõí' : 'üìà'} ${ticker}${date ? ' ‚Ä¢ '+date : ''}${kind ? ' ‚Ä¢ '+kind : ''}`;
  upcomingEl.appendChild(pill);
}

/* ===== Specials: OPEX & VIX Settlement (computed) ===== */
function thirdFriday(y, m){ const first = new Date(y, m, 1); const firstFri = 1 + ((5 - first.getDay() + 7) % 7); return new Date(y, m, firstFri + 14); }
function vixSettlementDate(y, m){
  const nextMonth = (m + 1 + 12) % 12; const y2 = y + Math.floor((m + 1) / 12);
  const thirdFriNext = thirdFriday(y2, nextMonth);
  const settle = new Date(thirdFriNext); settle.setDate(settle.getDate() - 30);
  while (settle.getDay() !== 3) { const diff = (3 - settle.getDay()); settle.setDate(settle.getDate() + diff); }
  return settle;
}
function within48h(dt){ const diff = dt - tzNow(); return diff >= 0 && diff <= 2*DAY; }
(function renderSpecials(){
  const y = now.getFullYear(), m = now.getMonth();
  [m-1, m, m+1].forEach(mm => {
    const mmN = (mm + 12) % 12, yN = y + Math.floor(mm / 12);
    const opex = thirdFriday(yN, mmN);
    if (between(opex, from, to)){ const pill=document.createElement('div'); pill.className='pill'; if (within48h(opex)) pill.classList.add('hl-tomorrow'); pill.textContent=`‚ö† Monthly OPEX ‚Ä¢ ${fmtDateISO(opex)}`; specialEl.appendChild(pill); }
    const vix = vixSettlementDate(yN, mmN);
    if (between(vix, from, to)){ const pill=document.createElement('div'); pill.className='pill'; if (within48h(vix)) pill.classList.add('hl-today'); pill.textContent=`‚ö† VIX Settlement (AM SOQ) ‚Ä¢ ${fmtDateISO(vix)}`; specialEl.appendChild(pill); }
  });
})();

/* ===== Earnings: Nasdaq Data Link (ZACKS/EA) ===== */
async function fetchEarningsNasdaqDL(fromISO, toISO, tickers){
  const nasdaqKey = await loadNasdaqKey();
  if (!nasdaqKey) throw new Error('Missing Nasdaq Data Link API key. Add it in ‚öôÔ∏è or /data/nasdaq_key.txt to load live earnings.');
  const tlist = (tickers||[]).map(s=>s.toUpperCase()).join(',');
  const url = `https://data.nasdaq.com/api/v3/datatables/ZACKS/EA.json?ticker=${encodeURIComponent(tlist)}&qopts.per_page=1000&api_key=${encodeURIComponent(nasdaqKey)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Nasdaq Data Link error: '+res.status);
  const json = await res.json();
  const dt = json && json.datatable;
  if (!dt || !dt.data || !dt.columns) return [];

  const cols = dt.columns.map(c => (c.name||'').toString());
  const findCol = (preds) => {
    const idx = cols.findIndex(name => preds.some(p => p.test(name.toLowerCase())));
    return idx >= 0 ? idx : -1;
  };
  const iTicker = findCol([/^ticker$/]);
  const iDate = findCol([/ann.*date/, /earn.*date/, /^date$/, /report.*date/]);
  const iTime = findCol([/ann.*time/, /time/]);

  if (iTicker < 0 || iDate < 0) return [];

  const byTicker = new Map();
  const today = startOfDay(tzNow());
  for (const row of dt.data){
    const t = String(row[iTicker] || '').toUpperCase();
    const ds = row[iDate];
    if (!t || !ds) continue;
    const d = new Date(String(ds).slice(0,10)+'T00:00:00');
    if (isNaN(+d) || d < today) continue;
    const best = byTicker.get(t);
    if (!best || d < best.when) byTicker.set(t, { ticker: t, when: d, date: ds, time: iTime>=0 ? row[iTime] : null });
  }

  const fromD = new Date(fromISO+'T00:00:00');
  const toD   = new Date(toISO+'T23:59:59');
  return Array.from(byTicker.values())
    .filter(x => between(x.when, fromD, toD))
    .map(x => ({ ticker: x.ticker, date: String(x.date).slice(0,10), kind: 'Earnings' }));
}

/* ===== Economic Calendar: TE with local fallback ===== */
const HIGH_IMPACT = ['CPI','PPI','Initial Jobless Claims','PCE','Non Farm Payrolls','Fed','FOMC','Powell'];
function pickEventDate(obj){
  const cands=[obj.Date,obj.DateUTC,obj.PubTime,obj.LastUpdate,obj.datetime,obj.date].filter(Boolean);
  for(const c of cands){ const d=new Date(c); if(!isNaN(+d)) return d; }
  return null;
}
function isHighImpactUS(ev){
  const name=(ev.name||ev.Event||ev.Category||'').toString();
  const country=(ev.Country||ev.country||'United States').toString();
  const hit=HIGH_IMPACT.some(k=>name.toLowerCase().includes(k.toLowerCase()));
  const isUS=country.toLowerCase().includes('united states')||['US','USA'].includes(country.toUpperCase());
  return hit && isUS;
}
async function fetchEconTE(d1,d2){
  const teKey = (localStorage.getItem('sachin:teKey') || '').trim();
  const cred = teKey ? encodeURIComponent(teKey) : 'guest:guest';
  const url = `https://api.tradingeconomics.com/calendar?country=United%20States&importance=2&d1=${d1}&d2=${d2}&c=${cred}&format=json`;
  const r = await fetch(url); if (!r.ok) throw new Error('TE error:'+r.status);
  const raw = await r.json();
  return raw.map(ev => ({ name: ev.Event || ev.Category, when: pickEventDate(ev), src:'TradingEconomics', Country: ev.Country }))
            .filter(x => x.when && isHighImpactUS(x))
            .filter(x => between(x.when, from, to));
}
async function fetchEconLocal(){
  try{
    const res = await fetch('./data/econ.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('econ.json missing');
    const rows = await res.json();
    return (rows || [])
      .map(ev => {
        const iso = ev.date + 'T' + (ev.time ? ev.time : '12:00') + ':00';
        const when = new Date(iso);
        return { name: ev.name || ev.title, when, src: 'Local', Country: ev.country || 'United States' };
      })
      .filter(x => x.name && x.when && isHighImpactUS(x))
      .filter(x => between(x.when, from, to));
  }catch(e){
    console.warn(e);
    return [];
  }
}
async function fetchEconMerged(d1, d2){
  try{
    const te = await fetchEconTE(d1, d2);
    if (te.length) return te;
  }catch(e){ console.warn('TE failed:', e); }
  return await fetchEconLocal();
}
function renderEcon(list, mount){
  mount.innerHTML = ''; list.sort((a,b)=>a.when-b.when);
  if (!list.length){
    const row = document.createElement('div');
    row.className = 'ev';
    row.innerHTML = `<div class="row"><div><strong>No high-impact events found</strong><br><small>Add items in <code>/data/econ.json</code> or set a TE key (‚öôÔ∏è).</small></div></div>`;
    mount.appendChild(row);
    return;
  }
  list.forEach(ev=>{
    const row=document.createElement('div'); row.className='ev';
    const hl=classifyHighlight(ev.when); if(hl) row.classList.add(hl);
    row.innerHTML=`<div class="row"><div><strong>${ev.name}</strong><br><small>${fmtHuman(ev.when)} ‚Ä¢ ${fmtTime(ev.when)}</small></div></div><small>${ev.src}</small>`;
    mount.appendChild(row);
  });
}

/* ===== Bootstrap ===== */
(async function main(){
  const fromISO = fmtDateISO(from), toISO = fmtDateISO(to);
  const thisWeekList = document.getElementById('thisWeekList');
  const nextWeekList = document.getElementById('nextWeekList');

  // Earnings (Nasdaq Data Link) ‚Äî watchlist only, no links
  let earningsUsed=false, econUsed=false, earningsWarn='';
  try{
    const items = await fetchEarningsNasdaqDL(fromISO, toISO, WATCHLIST);
    const coreOrder = { 'TSLA':0,'AAPL':1,'MSFT':2,'NVDA':3 };
    items.sort((a,b)=> (coreOrder[a.ticker] ?? 999) - (coreOrder[b.ticker] ?? 999) || (new Date(a.date)-new Date(b.date)));
    items.forEach(x => addPill(x));
    if (items.length) earningsUsed=true;
    if (!items.length) earningsWarn='No earnings returned for window (check key or watchlist).';
  }catch(e){ console.warn(e); earningsWarn = e.message; }

  if (upcomingEl.children.length === 0){
    const pill=document.createElement('div'); pill.className='pill'; pill.textContent='‚ö† Add your Nasdaq Data Link API key in ‚öôÔ∏è or /data/nasdaq_key.txt to load live earnings.'; upcomingEl.appendChild(pill);
  }

  // ECON: merged (TE ‚Üí local fallback)
  try{
    const teThis = await fetchEconMerged(fmtDateISO(thisMon), fmtDateISO(thisSun));
    const teNext = await fetchEconMerged(fmtDateISO(nextMon), fmtDateISO(nextSun));
    renderEcon(teThis, thisWeekList);
    renderEcon(teNext, nextWeekList);
    if (teThis.length || teNext.length) econUsed=true;
  }catch(e){ console.warn(e); }

  // Banner
  const parts=[]; if(earningsUsed) parts.push('Earnings (Nasdaq Data Link: ZACKS/EA)'); if(econUsed) parts.push('Economic calendar (TE/Local)');
  let txt = parts.length ? `LIVE: ${parts.join(' + ')} (14-day window).` : `Nothing loaded yet.`;
  if (earningsWarn) txt += ` <span class="warn">‚Ä¢ ${earningsWarn}</span>`;
  liveBanner.style.display='block';
  liveBanner.innerHTML = txt;
})();
</script>

<script>
// Register Service Worker (PWA)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .catch(err => console.warn('SW reg failed', err));
  });
}
</script>
</body>
</html>
