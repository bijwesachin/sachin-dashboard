<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sachin Dashboard ‚Äî v1.6 LIVE (2-week window)</title>
<meta name="description" content="LIVE market dashboard with strict 14-day window for earnings, econ, and specials.">
<style>
  :root{
    --bg:#121212; --panel:#1d1a16; --muted:#2a2620; --text:#f2f2f2;
    --accent:#ff8c00; --accent-2:#6a4a1f; --warn:#8b0000;
    --sales-bg:#153a28; --sales-br:#1f6a4a;
  }
  *{box-sizing:border-box} body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  header{padding:10px 14px;background:var(--panel);display:flex;gap:12px;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;border-bottom:1px solid #2a2620}
  header .title{display:flex;align-items:center;gap:10px}
  header .badge{font-size:.75rem;opacity:.8;border:1px solid #333;border-radius:999px;padding:2px 8px}
  button{background:var(--accent);color:#1a1209;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  button:active{transform:translateY(1px)} .wrap{padding:16px;max-width:1100px;margin:0 auto}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);padding:14px;border-radius:12px;border:1px solid #2a2620}
  h3{margin:.2rem 0 1rem;font-weight:800}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .pill{padding:8px 12px;border-radius:999px;background:var(--muted);border:1px solid #3b3227;display:flex;gap:10px;align-items:center;white-space:nowrap}
  .pill a{color:var(--text);text-decoration:none;border-bottom:1px dashed #5d4b33}
  .pill.sales{background:var(--sales-bg);border-color:var(--sales-br)}
  .pill.highlight{background:#3a2815;border-color:var(--accent-2)}
  .ev{background:var(--muted);padding:10px;border-radius:10px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;border:1px solid #3b3227}
  .ev.highlight{background:#3a2815;border-color:var(--accent-2)}
  .row{display:flex;gap:8px;align-items:center}
  small{opacity:.8} .section-note{opacity:.75;font-size:.9rem;margin:.5rem 0 0}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .settings{display:none;position:fixed;right:16px;bottom:16px;background:var(--panel);border:1px solid #3b3227;border-radius:12px;padding:12px;max-width:360px;z-index:20}
  .settings input{width:100%;padding:8px;border-radius:8px;border:1px solid #3b3227;background:#15110c;color:var(--text);margin-top:6px}
  .settings label{font-size:.9rem;opacity:.9}
  .banner{margin:12px 0;padding:10px;border-radius:10px;background:#21160f;border:1px dashed #5d4b33}
  .error{color:#ffcccc}

  .hl-today{ background:#1f3b2a; border-color:#2f7a4a; }      /* light green */
  .hl-tomorrow{ background:#3a2a15; border-color:#a86e1a; }   /* light orange */

</style>

  <!-- PWA hooks -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Sachin Dashboard">
  <link rel="apple-touch-icon" href="icons/icon-180.png">

</head>
<body>
<header>
  <div class="title">
    <div style="font-weight:900;">Sachin Dashboard</div>
    <span class="badge">v1.6 LIVE ¬∑ 14-day</span>
  </div>
  <div class="controls">
    <button id="toggleNextWeek">Show next week</button>
    <button id="refreshBtn">Refresh</button>
    <button id="settingsBtn" title="Settings (API Keys)">‚öôÔ∏è Settings</button>
  </div>
</header>

<div class="wrap">
  <div id="liveBanner" class="banner" style="display:none"></div>

  <div class="grid">
    <div class="card">
      <h3>Upcoming earnings & sales (next 14 days)</h3>
      <div id="upcomingList" class="chips"></div>
      <div class="section-note">Strict window: today ‚Üí +14 days. Core tickers prioritized (TSLA, AAPL, MSFT, NVDA).</div>
    </div>

    <div class="card">
      <h3>Specials (next 14 days)</h3>
      <div id="specialList" class="chips"></div>
      <div class="section-note">Monthly OPEX & VIX Settlement (SOQ) shown only if inside the next 14 days.</div>
    </div>
  </div>

  <div class="card" id="thisWeek">
    <h3 id="thisWeekTitle">Economic events ‚Äî This week</h3>
    <div id="thisWeekList"></div>
  </div>

  <div class="card" id="nextWeek" style="display:none;">
    <h3 id="nextWeekTitle">Economic events ‚Äî Next week</h3>
    <div id="nextWeekList"></div>
  </div>
</div>

<!-- Settings panel -->
<div class="settings" id="settingsPanel">
  <h4 style="margin:0 0 8px">üîß Settings</h4>
  <div>
    <label>FMP API Key (for Earnings Calendar)</label>
    <input id="fmpKey" placeholder="e.g. demo or your key">
  </div>
  <div style="margin-top:8px">
    <label>TradingEconomics Key (optional)</label>
    <input id="teKey" placeholder="guest:guest or your_key:your_secret">
  </div>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="saveKeys">Save</button>
    <button id="closeSettings">Close</button>
  </div>
  <div class="section-note">Keys are stored in your browser (localStorage) only.</div>
</div>

<script>
/* ===== Utils ===== */
function tzNow(){ return new Date(); }
const DAY = 86400000;
function addDays(d, n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+n); }
function fmtDateISO(d){ const m = String(d.getMonth()+1).padStart(2,'0'); const day = String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; }
function fmtHuman(d){ return d.toLocaleString(undefined, {weekday:'short', month:'short', day:'numeric'}); }
function fmtTime(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
function within48h(dt){ const now = tzNow(); const diff = dt - now; return diff >= 0 && diff <= 2*DAY; }

function classifyHighlight(dt){
  if(!(dt instanceof Date)) return '';
  const now = tzNow();
  const todayStart = startOfDay(now);
  const todayEnd   = endOfDay(now);
  const tomorrowStart = addDays(todayStart, 1);
  const tomorrowEnd   = endOfDay(tomorrowStart);
  if (between(dt, todayStart, todayEnd)) return 'hl-today';
  if (between(dt, tomorrowStart, tomorrowEnd)) return 'hl-tomorrow';
  return '';
}

function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function endOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999); }
function between(dt, from, to){ return dt >= from && dt <= to; }

/* ===== Controls ===== */
const refreshBtn = document.getElementById('refreshBtn');
refreshBtn.addEventListener('click', () => location.reload(true));
const toggleBtn = document.getElementById('toggleNextWeek');
const nextWeekCard = document.getElementById('nextWeek');
toggleBtn.addEventListener('click', () => {
  const show = nextWeekCard.style.display === 'none';
  nextWeekCard.style.display = show ? 'block' : 'none';
  toggleBtn.textContent = show ? 'Hide next week' : 'Show next week';
});

/* ===== Ranges ===== */
const now = tzNow();
const from = startOfDay(now);
const to   = endOfDay(addDays(now, 14));
const dayIdx = (now.getDay()+6)%7; // Mon=0
const thisMon = addDays(now, -dayIdx);
const thisSun = addDays(thisMon, 6);
const nextMon = addDays(thisMon, 7);
const nextSun = addDays(thisSun, 7);

function titleRange(start, end){
  const opts = { month:'short', day:'numeric', year:'numeric'};
  return `${start.toLocaleDateString(undefined,opts)} ‚Üí ${end.toLocaleDateString(undefined,opts)}`;
}
document.getElementById('thisWeekTitle').textContent = `Economic events ‚Äî This week (${titleRange(thisMon, thisSun)})`;
document.getElementById('nextWeekTitle').textContent = `Economic events ‚Äî Next week (${titleRange(nextMon, nextSun)})`;

/* ===== Settings storage ===== */
const settingsBtn = document.getElementById('settingsBtn');
const settingsPanel = document.getElementById('settingsPanel');
const fmpKeyInput = document.getElementById('fmpKey');
const teKeyInput  = document.getElementById('teKey');
document.getElementById('closeSettings').onclick = () => settingsPanel.style.display = 'none';
settingsBtn.onclick = () => {
  const { fmpKey, teKey } = loadKeys();
  fmpKeyInput.value = fmpKey || '';
  teKeyInput.value = teKey || '';
  settingsPanel.style.display = 'block';
};
document.getElementById('saveKeys').onclick = () => {
  localStorage.setItem('sachin:fmpKey', fmpKeyInput.value.trim());
  localStorage.setItem('sachin:teKey', teKeyInput.value.trim());
  settingsPanel.style.display = 'none';
  location.reload();
};
function loadKeys(){
  return {
    fmpKey: localStorage.getItem('sachin:fmpKey') || '',
    teKey:  localStorage.getItem('sachin:teKey')  || '',
  };
}

/* ===== UI helpers ===== */
const WATCHLIST = ["HOOD", "NVDA", "PLTR", "AMD", "AAPL", "GOOG", "TSLA", "TSM", "AVGO", "MSFT", "ARM", "AMZN", "SPXL", "TQQQ", "SMCI", "COIN", "AI", "WMT", "META", "NFLX", "COST", "LOW", "TGT", "CSCO", "CRWV"];

const upcomingEl = document.getElementById('upcomingList');
const specialEl  = document.getElementById('specialList');
const liveBanner = document.getElementById('liveBanner');
function linkRow(ticker){
  const y = `https://finance.yahoo.com/quote/${encodeURIComponent(ticker)}`;
  const tv = `https://www.tradingview.com/symbols/${encodeURIComponent(ticker)}`;
  return `
    <span>üìà <strong>${ticker}</strong></span>
    <a href="${y}" target="_blank" rel="noopener">Yahoo</a>
    <span>¬∑</span>
    <a href="${tv}" target="_blank" rel="noopener">TradingView</a>
  `;
}
function addPill({text, date, kind, sales=false, ticker}){
  const pill = document.createElement('div');
  pill.className = 'pill' + (sales ? ' sales' : '');
  const d = date ? new Date(date+'T00:00:00') : null;
  if (d){ const hl = classifyHighlight(d); if (hl) pill.classList.add(hl); }
  const main = text || (ticker ? `${ticker} ‚Ä¢ ${date} ‚Ä¢ ${kind||''}` : '');
  pill.innerHTML = (sales ? 'üõí ' : 'üìà ') + main + (ticker ? ` <span style="opacity:.6;">|</span> ${linkRow(ticker)}` : '');
  upcomingEl.appendChild(pill);
}

/* ===== Specials: OPEX & VIX Expiration (strict 14 days) ===== */

function thirdFriday(y, m){ // m: 0-11
  const first = new Date(y, m, 1);
  let day = 1 + ((5 - first.getDay() + 7) % 7); // first Friday
  day += 14; // third Friday
  return new Date(y, m, day);
}
function wednesdayBefore(date){
  const d = new Date(date);
  while (d.getDay() !== 3) d.setDate(d.getDate()-1); // 3 = Wed
  return d;
}
function tuesdayBefore(date){
  const d = wednesdayBefore(date);
  d.setDate(d.getDate()-1); // Tuesday before settlement
  return d;
}

function renderSpecials(){
  const y = now.getFullYear(), m = now.getMonth(); // current month index
  const months = [m-1, m, m+1]; // cover window straddles within 14 days

  function thirdFriday(y, m){ // m: 0-11
    const first = new Date(y, m, 1);
    const firstFri = 1 + ((5 - first.getDay() + 7) % 7);
    return new Date(y, m, firstFri + 14); // 3rd Friday
  }

  // VIX monthly settlement (SOQ) = Wednesday that's 30 calendar days before next month's 3rd Friday
  function vixMonthlySettlement(y, m){
    const nextMonth = (m + 1 + 12) % 12;
    const yearAdj = y + Math.floor((m + 1) / 12);
    const thirdFriNext = thirdFriday(yearAdj, nextMonth);
    const settle = new Date(thirdFriNext);
    settle.setDate(settle.getDate() - 30);
    // Normalize to Wednesday (spec implies Wednesday; this guards against oddities):
    while (settle.getDay() !== 3) { // 3 = Wed
      const diff = (3 - settle.getDay());
      settle.setDate(settle.getDate() + diff);
    }
    return settle;
  }

  months.forEach(mm => {
    const mmN = (mm + 12) % 12, yN = y + Math.floor(mm / 12);

    // Monthly OPEX (3rd Friday of current iterated month)
    const opex = thirdFriday(yN, mmN);
    if (between(opex, from, to)){
      const pill1 = document.createElement('div');
      pill1.className = 'pill';
      if (within48h(opex)) pill1.classList.add('highlight');
      pill1.textContent = `‚ö† Monthly OPEX ‚Ä¢ ${fmtDateISO(opex)}`;
      specialEl.appendChild(pill1);
    }

    // VIX Settlement aligned to the NEXT month per Cboe spec
    const vixSettle = vixMonthlySettlement(yN, mmN);
    if (between(vixSettle, from, to)){
      const pill2 = document.createElement('div');
      pill2.className = 'pill';
      if (within48h(vixSettle)) pill2.classList.add('highlight');
      pill2.textContent = `‚ö† VIX Settlement (AM SOQ) ‚Ä¢ ${fmtDateISO(vixSettle)}`;
      specialEl.appendChild(pill2);
    }
  });
}
renderSpecials();





/* Optional local SALES placeholders (keep empty unless you add a date):
   Example: { ticker:'AAPL', date:'2025-09-10', kind:'Sales report' }
*/
const SALES_LOCAL = [];

/* ===== LIVE Providers ===== */
async function fetchEarningsFMP(fromISO, toISO, tickers){
  const { fmpKey } = loadKeys();
  if (!fmpKey){ throw new Error('Missing FMP API key'); }
  const url = `https://financialmodelingprep.com/api/v3/earning_calendar?from=${fromISO}&to=${toISO}&apikey=${encodeURIComponent(fmpKey)}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('FMP error: '+r.status);
  const data = await r.json();
  const wanted = new Set(WATCHLIST);
  return data
    .filter(x => x.symbol && x.date)
    .filter(x => { const d = new Date(x.date+'T00:00:00'); return between(d, from, to); })
    .map(x => ({ ticker: x.symbol, date: x.date, kind: 'Earnings' }));
}

async function fetchEconTE(d1, d2){
  const { teKey } = loadKeys();
  const cred = teKey ? encodeURIComponent(teKey) : 'guest:guest';
  const url = `https://api.tradingeconomics.com/calendar?country=United%20States&importance=2&d1=${d1}&d2=${d2}&c=${cred}&format=json`;
  const r = await fetch(url);
  if (!r.ok) throw new Error('TE error: '+r.status);
  const data = await r.json();
  const keep = ['CPI', 'PPI', 'Initial Jobless Claims', 'PCE', 'Non Farm Payrolls', 'Fed'];
  return data
    .filter(ev => {
      const n = (ev.Event || ev.Category || '').toString();
      return keep.some(k => n.toLowerCase().includes(k.toLowerCase()));
    })
    .map(ev => ({
      name: ev.Event || ev.Category,
      when: new Date(ev.Date || ev.DateUTC || ev.DateSpan || ev.PubTime || ev.LastUpdate || Date.now()),
      src: 'TradingEconomics'
    }))
    .filter(ev => between(ev.when, from, to));
}

/* ===== Render Econ Lists ===== */
function renderEcon(list, mount){
  list.sort((a,b) => a.when - b.when);
  list.forEach(ev => {
    const row = document.createElement('div');
    row.className = 'ev';
    var _h = classifyHighlight(ev.when); if (_h) row.classList.add(_h);
    row.innerHTML = `
      <div class="row">
        <div><strong>${ev.name}</strong><br><small>${fmtHuman(ev.when)} ‚Ä¢ ${fmtTime(ev.when)}</small></div>
      </div>
      <small>${ev.src}</small>`;
    mount.appendChild(row);
  });
}

/* ===== Bootstrap: Earnings + Econ (strict 14 days) ===== */
(async function main(){
  const fromISO = fmtDateISO(from), toISO = fmtDateISO(to);
  const core = WATCHLIST;
  let usedLive = false;
  let econLiveUsed = false;

  // LIVE earnings
  try{
    const earn = await fetchEarningsFMP(fromISO, toISO, core);
    const coreOrder = { 'TSLA':0,'AAPL':1,'MSFT':2,'NVDA':3 };
    earn.sort((a,b)=> (coreOrder[a.ticker] ?? 999) - (coreOrder[b.ticker] ?? 999) || (new Date(a.date)-new Date(b.date)));
    earn.forEach(x => addPill({ticker:x.ticker, date:x.date, kind:x.kind}));
    if (earn.length) usedLive = true;
  }catch(e){ console.warn(e); }

  // Also show local SALES if in window
  SALES_LOCAL.filter(x => x.ticker && x.date).forEach(x => {
    const d = new Date(x.date+'T00:00:00');
    if (between(d, from, to)) addPill({ticker:x.ticker, date:x.date, kind:x.kind||'Sales', sales:true});
  });

  // Fallback sample if none
  if (upcomingEl.children.length === 0){
    const sample = [
      { t:'TSLA', date:'2025-08-28', kind:'Deliveries/Sales', sales:true },
      { t:'AAPL', date:'2025-09-10', kind:'Sales report' },
      { t:'MSFT', date:'2025-10-29', kind:'Earnings' },
      { t:'NVDA', date:'2025-08-27', kind:'Earnings' },
    ].filter(s => { const d=new Date(s.date+'T00:00:00'); return between(d, from, to); });
    sample.forEach(s => addPill({ticker:s.t, date:s.date, kind:s.kind, sales:!!s.sales}));
  }

  // ECON (fetch week buckets, then filter to 14-day window)
  const thisWeekList = document.getElementById('thisWeekList');
  const nextWeekList = document.getElementById('nextWeekList');
  try{
    const teThis = await fetchEconTE(fmtDateISO(thisMon), fmtDateISO(thisSun));
    const teNext = await fetchEconTE(fmtDateISO(nextMon), fmtDateISO(nextSun));
    renderEcon(teThis, thisWeekList);
    renderEcon(teNext, nextWeekList);
    if (teThis.length || teNext.length) econLiveUsed = true;
  }catch(e){ console.warn(e); }

  // Fallback sample econ if empty after filter
  if (!thisWeekList.children.length && !nextWeekList.children.length){
    const dt = (y,m,d,hr,mi)=> new Date(y,m-1,d,hr,mi);
    const all = [
      { name:'CPI (Jul)',     when: dt(2025,8,12,7,30), src:'BLS' },
      { name:'PPI (Jul)',     when: dt(2025,8,14,7,30), src:'BLS' },
      { name:'Initial Jobless Claims', when: dt(2025,8,14,7,30), src:'DOL' },
      { name:'PCE Price Index (Jul)',  when: dt(2025,8,15,7,30), src:'BEA' },
      { name:'Nonfarm Payrolls (Jul)', when: dt(2025,8,15,7,30), src:'BLS' },
      { name:'Fed Chair Powell ‚Äî FOMC Remarks', when: dt(2025,8,15,13,0), src:'Federal Reserve' },
      { name:'CPI (Aug)',     when: dt(2025,8,19,7,30), src:'BLS' },
      { name:'PPI (Aug)',     when: dt(2025,8,21,7,30), src:'BLS' },
      { name:'Initial Jobless Claims', when: dt(2025,8,21,7,30), src:'DOL' },
      { name:'PCE Price Index (Aug)',  when: dt(2025,8,22,7,30), src:'BEA' },
      { name:'Nonfarm Payrolls (Aug)', when: dt(2025,8,22,7,30), src:'BLS' },
      { name:'Fed Chair Powell ‚Äî Economic Symposium', when: dt(2025,8,23,9,0), src:'Federal Reserve' },
    ].filter(ev => between(ev.when, from, to));
    // split into week buckets for display
    const wk1 = all.filter(ev => ev.when <= thisSun);
    const wk2 = all.filter(ev => ev.when >= nextMon);
    renderEcon(wk1, thisWeekList);
    renderEcon(wk2, nextWeekList);
  }

  // Live banner
  if (usedLive || econLiveUsed){
    liveBanner.style.display = 'block';
    liveBanner.textContent = `LIVE mode: ${usedLive ? 'Earnings' : ''}${(usedLive && econLiveUsed)?' + ':''}${econLiveUsed ? 'Economic calendar' : ''} (strict 14-day window).`;
  }else{
    liveBanner.style.display = 'block';
    liveBanner.innerHTML = `Using sample data (filtered to 14 days). <span class="error">Set API keys (‚öôÔ∏è) for live updates.</span>`;
  }
})();
</script>

<script>
// Register Service Worker (PWA)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .catch(err => console.warn('SW reg failed', err));
  });
}
</script>

</body>
</html>
